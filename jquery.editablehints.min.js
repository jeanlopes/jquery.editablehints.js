/*
 * Editable Hints jQuery Plugin
 * @author Stephen Saw
 * @version 1.0.0
 *
 * Copyright (c) 2013 Stephen Saw <stephen@stephensaw.me>
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */
(function(a){a.editablehints=function(j){var h=this,e,f=[],i=-1,g,d=false;var c=a.extend({editor:null,hints:[],className:"editablehints",trigger:"@",hintsBoxOffsetX:0,hintsBoxOffsetY:0},j);if(typeof j.editor==="string"){if(j.editor.indexOf("#")===0){c.editor=a(j.editor)}else{c.editor=a("#"+j.editor)}}else{c.editor=j.editor}if(!c.editor){throw"Editor is undefined"}g=a(c.editor);this.getSelection=function(){if(window.getSelection){return document.getSelection()}else{if(document.selection&&document.selection.createRange){return document.selection}}};this.getCaretPosition=function(){var l,k;if(window.getSelection){l=document.getSelection();k=l.getRangeAt(0);return k.startOffset}else{if(document.selection&&document.selection.createRange){k=document.selection.createRange();var m=document.body.createTextRange();m.moveToElementText(document.body);m.setEndPoint("EndToEnd",k);return m.text.length}else{throw"Implementation not supported"}}};this.getOffset=function(m){var l=0,k=0,n;while(m&&!isNaN(m.offsetLeft)&&!isNaN(m.offsetTop)){n=document.documentElement.scrollTop||m.scrollTop;l+=m.offsetLeft-m.scrollLeft;k+=m.offsetTop-n;m=m.offsetParent}return{top:k,left:l}};this.getCursorPosition=function(){var m,k,l,o;if(window.getSelection){m=document.getSelection();k=m.getRangeAt(0);l=document.createRange();$span=a("<span/>").css("position","absolute");l.setStart(m.focusNode,k.endOffset);l.insertNode($span[0]);o=h.getOffset($span[0]);$span.remove();return{x:o.left,y:o.top}}else{if(document.selection&&document.selection.createRange){var n=h.getSelectedNode();o=h.getOffset(n);return{x:o.left,y:o.top}}else{throw"Implementation not supported"}}};this.getSelectedNode=function(){var k;if(window.getSelection){k=document.getSelection();if(k.anchorNode){return k.anchorNode}}else{if(document.selection&&document.selection.createRange){k=document.selection.createRange();if(k.parentElement){return k.parentElement()}}else{throw"Implementation not supported"}}};this.selectText=function(n,q,l,s){var p;if(q<0){return{text:"",range:null}}if(document.getSelection){var r=document.getSelection();p=document.createRange();p.setStart(n,q);p.setEnd(n,l);if(s){r.removeAllRanges();r.addRange(p)}var o=r.anchorNode.data;if(o){return{text:o.substr(q,l),range:p}}else{return{text:"",range:null}}}else{if(document.selection&&document.selection.createRange){var m,k;if(q>=l){k=-1}else{k=q-l}p=document.selection.createRange();p.moveStart("character",k);p.select();m=p.text;p.collapse(false);p.select();return{text:m,range:null}}else{throw"Implementation not supported"}}};this.hints=function(k){f=[];a.each(c.hints,function(l,m){if(m&&m.text.toLowerCase().indexOf(k.toLowerCase())===0){f.push(m)}});h.renderHints(f)};this.replaceKeyword=function(n){var o=h.getCaretPosition(),k;if(window.getSelection){var m=h.getSelectedNode(),p=h.selectText(m,i,o,true);if(p){k=p.range;if(typeof n==="string"){document.execCommand("insertHTML",false,n)}else{k.insertNode(n)}}}else{if(document.selection&&document.selection.createRange){k=document.selection.createRange();k.moveStart("character",i-o);k.select();k.text="";if(k){if(typeof n==="string"){k.pasteHTML(n)}else{var l=document.createControlRange();l.addElement(n)}}}else{throw"Implementation not supported"}}};this.selectHint=function(l){var k=l.attr("index");h.replaceKeyword(f[k].value);h.stopHints()};this.renderHints=function(l){if(l.length>0){e.empty();var k=a('<ul tabindex="0"></ul>');a.each(l,function(n,o){k.append('<li tabindex="-1" index="'+n+'">'+o.text+"</li>")});k.children(":first-child").addClass("selected");var m=h.getCursorPosition();e.append(k);e.css({top:m.y+c.hintsBoxOffsetY,left:m.x+c.hintsBoxOffsetX});e.show();d=true}else{h.stopHints()}};this.stopHints=function(){e.empty();e.hide();d=false;i=-1};this.doSearch=function(){var n=h.getCaretPosition(),m=h.getSelectedNode(),l=c.trigger,o;if(!d){if(i===-1){i=n-1}}o=h.selectText(m,i,n-i).text;if(n>0&&o.indexOf(l)===0){d=true;var k=o;h.hints(k.substr(1,k.length-1))}else{h.stopHints()}};var b=a("<div></div>").addClass(c.className).appendTo("body");e=b;g.keydown(function(m){var k=m.keyCode||m.which;if(d){var l=e.find("ul > li.selected");switch(k){case 37:case 39:m.preventDefault();break;case 38:m.preventDefault();if(!l.is(":first-child")){l.removeClass("selected").prev().addClass("selected").get(0).scrollIntoView(false)}break;case 40:m.preventDefault();if(!l.is(":last-child")){l.removeClass("selected").next().addClass("selected").get(0).scrollIntoView(false)}break;case 13:m.preventDefault();h.selectHint(l);break;case 27:m.preventDefault();h.stopHints();break}}});g.keyup(function(l){var k=l.keyCode||l.which;if(k!==38&&k!==40&&k!==13&&k!==27&&k!==39&&k!==37){setTimeout(h.doSearch,1)}})}})(jQuery);